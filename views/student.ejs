<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title><%= student.name %> — Progress</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="/css/student.css">
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="logo"><img src="/assets/logo.png" style="width:100%;height:100%;object-fit:cover"/></div>
      <div>
        <div class="title">AMDI Student Progress</div>
        <div class="sub">Student — <%= student.matric %> · <%= student.programme %></div>
      </div>
      <div style="margin-left:auto;"><a href="/" class="btn">← Dashboard</a></div>
    </div>

    <div class="grid">
      <div>
        <div class="card student-card">
          <div class="avatar"><%= student.name.split(' ').map(n=>n[0]).slice(0,2).join('') %></div>
          <div class="student-meta">
            <h2><%= student.name %></h2>
            <p><strong>Matric:</strong> <%= student.matric %> | <strong>Program:</strong> <%= student.programme %></p>
            <div class="meta-list">
              <span class="badge"><strong>Status:</strong> <%= student.timeline.status %></span>
              <span class="muted">Supervisor: <%= student.supervisorEmail || '—' %></span>
            </div>
          </div>
        </div>

        <div id="donut" style="margin-top:14px;">
          <div id="donutChart" style="width:100%;height:220px;"></div>
        </div>

        <div style="text-align:center; margin-top:8px;">
          Overall progress: <strong><%= student.progress.percentage %>%</strong>
        </div>
      </div>

      <div class="right-pane">
        <div class="card">
          <h3>Milestones</h3>
          <table>
            <thead>
              <tr><th>Milestone</th><th>Expected (Quarter)</th><th>Submitted</th><th>Approved</th><th>Status</th></tr>
            </thead>
            <tbody>
              <% student.timeline.milestones.forEach(function(m) { %>
                <tr>
                  <td><strong><%= m.id %></strong></td>
                  <td><%= m.expectedQuarter %></td>
                  <td><%= m.submitted ? '✓' : '' %></td>
                  <td><%= m.approved ? '✓' : '' %></td>
                  <td>
                    <% if (m.approved) { %>
                      <span class="status-pill status-on">Approved</span>
                    <% } else if (m.submitted) { %>
                      <span class="status-pill status-sub">Submitted</span>
                    <% } else { %>
                      <span class="status-pill status-pend">Pending</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

        <div class="timeline-box">
          <h4>Timeline & Activities</h4>
          <div id="timelineChart" style="height:220px;"></div>

          <div style="margin-top:10px;">
            <strong>Activities grouped by milestone</strong>
            <div style="margin-top:8px;">
              <% ['P1','P3','P4','P5'].forEach(function(pid){ %>
                <div style="margin-bottom:8px;">
                  <strong><%= pid %> — <%= student.timeline.milestones.find(x=>x.id===pid).expectedQuarter %></strong>
                  <ul>
                    <% (student.activitiesGrouped && student.activitiesGrouped[pid] || []).forEach(function(act){ %>
                      <li><%= act %></li>
                    <% }) %>
                    <% if (!(student.activitiesGrouped && student.activitiesGrouped[pid] && student.activitiesGrouped[pid].length)) { %>
                      <li style="color:#888">No activities listed</li>
                    <% } %>
                  </ul>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const student = <%- JSON.stringify(student) %>;
    const timeline = student.timeline || { quarters: [], milestones: [] };

    (function(){
      const dom = document.getElementById('donutChart');
      const chart = echarts.init(dom);
      const pct = student.progress.percentage || 0;
      chart.setOption({
        title:{ text: pct + '%', left:'center', top:'40%', textStyle:{fontSize:22,color:'#0d47a1'}},
        series:[{ type:'pie', radius:['60%','85%'], label:{show:false}, data:[
          { value: pct, itemStyle:{ color: '#0d47a1' } },
          { value: 100-pct, itemStyle:{ color: '#eef3fb' } }
        ]}]
      });
      window.addEventListener('resize', ()=> chart.resize());
    })();

    (function(){
      const dom = document.getElementById('timelineChart');
      const chart = echarts.init(dom);
      const quarters = timeline.quarters || [];
      const milestones = timeline.milestones || [];

      const series = [];
      milestones.forEach((m) => {
        series.push({ name: m.id + ' expected', type: 'bar', stack: m.id, itemStyle:{ color: '#bdc3c7' }, data: quarters.map(q => q === m.expectedQuarter ? 1 : 0), barWidth: 16 });
        series.push({ name: m.id + ' submitted', type: 'bar', stack: m.id, itemStyle:{ color: '#f1c40f' }, data: quarters.map(q => (m.submitted && q === m.expectedQuarter) ? 1 : 0), barWidth: 16 });
        series.push({ name: m.id + ' approved', type: 'bar', stack: m.id, itemStyle:{ color: '#2ecc71' }, data: quarters.map(q => (m.approved && q === m.expectedQuarter) ? 1 : 0), barWidth: 16 });
      });

      chart.setOption({ tooltip:{}, grid:{ left:'3%', right:'4%', bottom:'3%', containLabel:true }, xAxis:{ type:'category', data: quarters }, yAxis:{ show:false }, series });
      window.addEventListener('resize', ()=> chart.resize());
    })();
  </script>
</body>
</html>
