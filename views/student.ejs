<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title><%= student.name %> — Progress</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
  <link rel="stylesheet" href="/css/student.css">
</head>
<body>
  <div class="container">
    <h1><%= student.name %> (<%= student.matric %>)</h1>
    <p>Programme: <%= student.programme %></p>
    <p>Start Date: <%= (student.startDate instanceof Date) ? student.startDate.toDateString() : new Date(student.startDate).toDateString() %></p>

    <div id="donut" style="width:300px;height:200px"></div>

    <h3>Milestones</h3>
    <table>
      <thead><tr><th>Milestone</th><th>Expected</th><th>Submitted</th><th>Approved</th></tr></thead>
      <tbody>
        <% student.timeline.milestones.forEach(function(m){ %>
          <tr>
            <td><%= m.id %></td>
            <td><%= m.expectedQuarter %></td>
            <td><%= m.submitted ? '✓' : '' %></td>
            <td><%= m.approved ? '✓' : '' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div id="timeline" style="height:220px"></div>
  </div>

  <script>
    const student = <%- JSON.stringify(student) %>;
    const pct = student.progress.percentage || 0;

    (function(){
      const c = echarts.init(document.getElementById('donut'));
      c.setOption({ title:{ text: pct+'%', left:'center'}, series:[{ type:'pie', radius:['60%','85%'], data:[{value:pct},{value:100-pct}] }] });
    })();

    (function(){
      const chart = echarts.init(document.getElementById('timeline'));
      const quarters = student.timeline.quarters;
      const milestones = student.timeline.milestones;
      const series = [];
      milestones.forEach(m=>{
        series.push({ name: m.id+' expected', type:'bar', stack:m.id, data: quarters.map(q=> q===m.expectedQuarter?1:0) });
        series.push({ name: m.id+' submitted', type:'bar', stack:m.id, data: quarters.map(q=> (m.submitted && q===m.expectedQuarter)?1:0) });
        series.push({ name: m.id+' approved', type:'bar', stack:m.id, data: quarters.map(q=> (m.approved && q===m.expectedQuarter)?1:0) });
      });
      chart.setOption({ xAxis:{ type:'category', data:quarters }, yAxis:{ show:false }, series });
    })();
  </script>
</body>
</html>
