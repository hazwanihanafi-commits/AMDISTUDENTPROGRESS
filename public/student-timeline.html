<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>AMDI — Student Timeline</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{
    --bg:#0f0b14; --card:#15121a; --accent:#6b2b9e; --muted:#bfb9c8; --glass: rgba(255,255,255,0.04);
    --accent2:#ffd400;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#0b0710 0%, #0f0b14 100%);color:#fff}
  .wrap{max-width:1100px;margin:32px auto;padding:20px}
  header{display:flex;align-items:center;gap:18px}
  header h1{margin:0;font-size:20px;letter-spacing:1px;color:var(--accent)}
  .top{display:flex;gap:12px;margin-top:18px;align-items:center}
  input[type="text"]{padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;min-width:260px}
  button{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:22px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
  .timeline-table{width:100%;border-collapse:collapse;font-size:13px;color:var(--muted)}
  .timeline-table th{background:linear-gradient(180deg, rgba(107,43,158,0.14), rgba(107,43,158,0.08));color:#fff;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03)}
  .timeline-table td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);vertical-align:middle}
  .quarter{width:34px;height:34px;border-radius:6px;display:inline-grid;place-items:center;background:var(--glass);cursor:pointer;border:1px solid rgba(255,255,255,0.04)}
  .quarter.on{background:linear-gradient(180deg,var(--accent),#8a5fe3);box-shadow:0 6px 18px rgba(107,43,158,0.2)}
  .legend{font-size:13px;color:var(--muted);margin-top:10px}
  /* progress ring */
  .progress-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
  .ring{width:220px;height:220px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--accent) 0deg,#222 0deg);box-shadow:inset 0 8px 20px rgba(255,255,255,0.02)}
  .ring-core{width:130px;height:130px;border-radius:50%;background:#0f0b14;display:grid;place-items:center;text-align:center}
  .pct{font-size:28px;color:var(--accent)}
  .muted{color:var(--muted);font-size:14px}
  @media (max-width:980px){ .layout{grid-template-columns:1fr} .ring{margin:0 auto} input[type="text"]{width:100%} }
</style>
</head>
<body>
  <div class="wrap">
    <header><h1>AMDI FUTURISTIC TIMELINE</h1></header>

    <div class="top">
      <input id="matric" placeholder="Enter matric (e.g. 23200051)">
      <select id="template"><option value="m">MSc template</option><option value="p">PhD template</option></select>
      <button id="loadBtn">Load</button>
      <div style="margin-left:auto" id="status" class="muted">idle</div>
    </div>

    <div class="layout">
      <div class="card">
        <div id="studentInfo" style="margin-bottom:12px">
          <div style="font-size:16px;font-weight:700" id="studentName">—</div>
          <div class="muted" id="startDate">Start date: —</div>
          <div class="muted" id="lastUpdate">Last update: —</div>
        </div>

        <div style="overflow:auto;max-height:520px">
          <table class="timeline-table" id="tl">
            <thead>
              <tr>
                <th style="width:34%">Activity</th>
                <th style="width:12%">Portfolio</th>
                <th colspan="12" style="text-align:center">Timeline (quarters)</th>
              </tr>
              <tr>
                <th></th><th></th>
                <!-- quarter header row will be injected -->
                <th id="qcols"></th>
              </tr>
            </thead>
            <tbody id="tbody">
              <!-- rows injected -->
            </tbody>
          </table>
        </div>

        <div class="legend">Click a quarter to toggle (saves automatically).</div>
      </div>

      <div class="card progress-wrap">
        <div class="ring" id="ring" style="background:conic-gradient(var(--accent) 0deg,#222 0deg)">
          <div class="ring-core">
            <div class="pct" id="pct">0%</div>
            <div class="muted">Progress</div>
          </div>
        </div>
        <div style="width:100%;text-align:center">
          <button id="printBtn">Open printable</button>
        </div>
        <div style="margin-top:8px;width:100%;text-align:left">
          <div class="muted">Milestones</div>
          <div id="milestones" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

<script>
async function fetchJson(url, opts){ const r = await fetch(url, opts); return await r.json(); }
function setStatus(s){ document.getElementById('status').textContent = s; }

function buildQuarterHeader(quarterKeys){
  const headerRow = document.createElement('tr');
  headerRow.innerHTML = '<th></th><th></th>';
  quarterKeys.forEach(k => {
    const th = document.createElement('th');
    th.style.padding = '6px'; th.style.fontSize = '12px';
    th.textContent = k;
    headerRow.appendChild(th);
  });
  return headerRow;
}

function buildRows(activities, quarterKeys){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  activities.forEach((a,i) => {
    const tr = document.createElement('tr');
    const tdAct = document.createElement('td'); tdAct.textContent = a.activity;
    const tdPortfolio = document.createElement('td'); tdPortfolio.textContent = ''; // placeholder
    tr.appendChild(tdAct); tr.appendChild(tdPortfolio);
    quarterKeys.forEach(k => {
      const td = document.createElement('td');
      td.style.textAlign = 'center';
      const span = document.createElement('div');
      span.className = 'quarter';
      span.dataset.activity = a.activity;
      span.dataset.key = k;
      if (a.quarterTicks && a.quarterTicks[k]) span.classList.add('on'), span.textContent = '✓';
      span.addEventListener('click', onQuarterClick);
      td.appendChild(span);
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

async function onQuarterClick(e){
  const el = e.currentTarget;
  const matric = document.getElementById('matric').value.trim();
  if (!matric) return alert('Enter matric');
  const key = el.dataset.key;
  const nowOn = !el.classList.contains('on');
  el.classList.toggle('on', nowOn);
  el.textContent = nowOn ? '✓' : '';
  setStatus('saving...');
  try {
    const body = { matric, column: key, value: nowOn ? '✓' : '' };
    const r = await fetch('/api/update_timeline', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await r.json();
    if (j.status !== 'ok') { alert('save failed'); }
    await load(); // refresh progress
  } catch(err){ console.error(err); alert('save error'); }
  setStatus('saved');
}

function updateProgressUI(activities, milestones){
  const stages = ['P1','P3','P4','P5'];
  let done = 0;
  stages.forEach(s => { if (milestones[s] && String(milestones[s]).trim()!=='') done++; });
  const pct = Math.round((done / stages.length) * 100);
  document.getElementById('pct').textContent = pct + '%';
  const deg = Math.round((pct/100)*360);
  document.getElementById('ring').style.background = `conic-gradient(var(--accent) ${deg}deg,#222 ${deg}deg)`;
  // milestones
  const mdiv = document.getElementById('milestones');
  mdiv.innerHTML = '';
  for (const k in milestones) {
    const d = document.createElement('div');
    d.textContent = `${k}: ${milestones[k] || '--'}`;
    mdiv.appendChild(d);
  }
}

async function load(){
  const matric = document.getElementById('matric').value.trim();
  if (!matric) { alert('enter matric'); return; }
  const tpl = document.getElementById('template').value;
  setStatus('loading...');
  try {
    const j = await fetchJson(`/api/timeline?matric=${encodeURIComponent(matric)}&template=${tpl}`);
    if (j.status !== 'ok') { setStatus('not found'); alert('student not found'); return; }
    document.getElementById('studentName').textContent = j.studentName || '—';
    document.getElementById('startDate').textContent = 'Start date: ' + (new Date(j.startDate)).toLocaleDateString();
    document.getElementById('lastUpdate').textContent = 'Last update: ' + (j.lastUpdate || '--');

    // build quarter header
    const qheadContainer = document.getElementById('qcols');
    // replace header row (second thead row)
    const thead = document.querySelector('.timeline-table thead');
    // remove existing second row if exists
    if (thead.children.length > 2) { thead.removeChild(thead.children[2]); }
    const hdr = buildQuarterHeader(j.quarterKeys);
    thead.appendChild(hdr);

    buildRows(j.activities, j.quarterKeys);
    updateProgressUI(j.activities, j.milestones);

    setStatus('ok');
  } catch(err){
    console.error(err);
    setStatus('error');
    alert('error loading timeline');
  }
}

document.getElementById('loadBtn').addEventListener('click', load);
document.getElementById('printBtn').addEventListener('click', ()=> {
  const m = document.getElementById('matric').value.trim();
  if (!m) return alert('enter matric');
  window.open('/printable.html?matric=' + encodeURIComponent(m), '_blank');
});
</script>
</body>
</html>
