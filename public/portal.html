<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>AMDI Student Progress</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --purple:#5b2b7b;
      --accent:#f2e6f5;
      --muted:#666;
      --card:#fff;
      --green:#9fd8a3;
      --box:#efefef;
    }
    body{font-family: "Segoe UI", Roboto, Arial; margin:0; background:#fafafa; color:#222}
    header{background:var(--purple); color:#fff; padding:18px 28px; display:flex; align-items:center; gap:20px}
    header .title{font-size:28px; font-weight:700; letter-spacing:1px}
    .container{display:flex; gap:28px; padding:22px; max-width:1200px; margin:20px auto;}
    .left{flex:1; background:var(--card); padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .right{width:340px; background:linear-gradient(180deg,var(--accent),#fff); padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .field{margin-bottom:8px}
    label{font-weight:600; margin-right:6px}
    .meta{color:var(--muted); font-size:14px}
    .big{font-size:20px; font-weight:700}
    .actions{margin-top:12px}
    input[type="text"]{padding:8px 10px; font-size:16px; width:260px; border:1px solid #ccc; border-radius:4px}
    button{padding:8px 12px; font-size:15px; border-radius:6px; background:#fff; border:1px solid #bbb; cursor:pointer}
    button.primary{background:var(--purple); color:#fff; border-color:var(--purple)}
    pre{background:#fafafa; border-radius:6px; padding:10px; border:1px solid #eee; white-space:pre-wrap}
    .donut{display:flex;align-items:center;justify-content:center;position:relative;height:220px}
    .donut .ring{width:160px;height:160px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--purple) 0deg,var(--purple) 0deg,#eee 0deg);box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .donut .ring .core{width:100px;height:100px;border-radius:50%;background:#fff;display:grid;place-items:center;text-align:center}
    .donut .ring .core .pct{font-size:20px;font-weight:800;color:var(--purple)}
    .timeline{margin-top:18px;border-collapse:collapse;width:100%}
    .timeline th, .timeline td{border:1px solid #e6e6e6;padding:6px;font-size:13px}
    .timeline th{background:#f6f3f8;font-weight:700;color:var(--purple);text-align:left}
    .activity{width:320px; font-weight:600}
    .tick{width:26px;height:26px;display:inline-grid;place-items:center;border-radius:4px;border:1px solid #ccc;background:#fff}
    .tick.done{background:var(--green); border-color:rgba(0,0,0,0.06)}
    .files{margin-top:10px}
    .file a{display:inline-block;padding:6px 10px;margin:6px 6px 0 0;background:#fff;border:1px solid #e6e6e6;border-radius:6px;text-decoration:none;color:var(--purple)}
    .legend{margin-top:12px;font-size:13px;color:var(--muted)}
    footer{max-width:1200px;margin:20px auto;text-align:center;color:#777;font-size:13px}
    /* responsive */
    @media (max-width:980px){
      .container{flex-direction:column;padding:12px}
      .right{width:100%}
      input[type="text"]{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:14px">
      <img src="" alt="" style="height:42px;opacity:0.9"/>
      <div class="title">AMDI STUDENT PROGRESS</div>
    </div>
  </header>

  <div class="container">
    <div class="left">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="field"><label>Student Name:</label><span id="studentName" class="big">—</span></div>
          <div class="field"><label>Matric No:</label><span id="matricView" class="meta">—</span></div>
          <div class="field"><label>Start Date:</label><span id="startDate" class="meta">—</span></div>
          <div class="field"><label>Main Supervisor:</label><span id="supervisor" class="meta">—</span></div>
          <div class="field"><label>Last Update:</label><span id="lastUpdate" class="meta">—</span></div>
        </div>

        <div style="text-align:center">
          <div class="donut">
            <div class="ring" id="donutRing" aria-hidden="true">
              <div class="core">
                <div class="pct" id="pctText">0%</div>
                <div style="font-size:11px;color:var(--muted)">PROGRESS</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <h3 style="margin-top:8px;color:var(--purple)">Timeline & Milestones</h3>

      <table class="timeline" id="timelineTable">
        <thead>
          <tr>
            <th class="activity">Activity</th>
            <th>Portfolio</th>
            <th style="width:70px;text-align:center">P1</th>
            <th style="width:70px;text-align:center">P3</th>
            <th style="width:70px;text-align:center">P4</th>
            <th style="width:70px;text-align:center">P5</th>
          </tr>
        </thead>
        <tbody id="timelineBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>

      <div class="files" id="fileList"></div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <input type="text" id="matric" placeholder="Enter matric (e.g. 23200051)" />
        <button class="primary" onclick="check()">Check</button>
        <button onclick="loadDashboard()">Load Dashboard</button>
        <div style="flex:1"></div>
        <div style="font-size:13px;color:var(--muted)">API status: <span id="apiStatus">idle</span></div>
      </div>

      <div style="margin-top:12px">
        <details>
          <summary style="cursor:pointer">Supervisor / Admin actions</summary>
          <div style="padding:10px">
            <input id="_svpass" type="password" placeholder="Supervisor pass"/>
            <input id="_svmat" type="text" placeholder="Matric to approve" style="margin-left:8px"/>
            <select id="_svstage">
              <option value="P1">P1</option>
              <option value="P3">P3</option>
              <option value="P4">P4</option>
              <option value="P5">P5</option>
            </select>
            <button onclick="approve()">Approve</button>
            <div id="approveResult" style="margin-top:8px;color:var(--muted)"></div>
          </div>
        </details>
      </div>

    </div>

    <div class="right">
      <div style="font-weight:700;color:var(--purple);font-size:18px;margin-bottom:6px">Summary</div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px">A quick glance of progress</div>

      <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04)">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:20px;font-weight:700" id="summaryCompleted">0 / 4</div>
            <div style="font-size:12px;color:var(--muted)">Milestones Completed</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:14px;font-weight:700" id="summaryTotal">Total students: 0</div>
            <div style="font-size:12px;color:var(--muted)">from dashboard</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="legend"><span style="display:inline-block;width:12px;height:12px;background:var(--green);margin-right:8px;border-radius:2px"></span> Completed</div>
          <div class="legend"><span style="display:inline-block;width:12px;height:12px;background:#fff;border:1px solid #ddd;margin-right:8px;border-radius:2px"></span> Pending</div>
        </div>
      </div>

      <div style="margin-top:18px;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.04)">
        <div style="font-weight:700;color:var(--purple)">Quick Actions</div>
        <div style="margin-top:10px">
          <button onclick="downloadApprovalLog()">Download Approval Log (CSV)</button>
        </div>
      </div>

    </div>
  </div>

  <footer>AMDI &nbsp; &middot; &nbsp; Student Progress System</footer>

<script>
/*
  Portal JS:
  - calls /api/status?matric=...
  - expects milestones object with P1/P1Approved/P3/... keys
  - renders timeline rows & donut
*/

// define activities in the same order as your sheet template
const ACTIVITIES = [
  "Registration & Orientation",
  "Literature Review & Proposal Preparation",
  "Proposal Defence",
  "Research Ethics Approval (JEPeM)",
  "Research Implementation I",
  "Mid-Candidature Review",
  "Research Communication I",
  "Research Implementation II",
  "Publication I",
  "Research Dissemination",
  "Thesis Preparation",
  "Pre-Submission Review (JPMPMP)",
  "Thesis Examination & Completion"
];

// map activity -> which milestone column indicates it's submitted
// this mapping is flexible: update if your sheet uses other fields
const ACT_TO_COL = {
  // early items -> P1
  "Registration & Orientation": "P1",
  "Literature Review & Proposal Preparation": "P1",
  "Proposal Defence":"P1",
  "Research Ethics Approval (JEPeM)":"P1",
  // mid -> P3
  "Research Implementation I":"P3",
  "Mid-Candidature Review":"P3",
  "Research Communication I":"P3",
  // later -> P4
  "Research Implementation II":"P4",
  "Publication I":"P4",
  "Research Dissemination":"P4",
  "Thesis Preparation":"P4",
  // final -> P5
  "Pre-Submission Review (JPMPMP)":"P5",
  "Thesis Examination & Completion":"P5"
};

function setApiStatus(s){ document.getElementById('apiStatus').textContent = s; }

/** Build the empty timeline rows */
function buildTimeline(){
  const tbody = document.getElementById('timelineBody');
  tbody.innerHTML = '';
  for(const a of ACTIVITIES){
    const tr = document.createElement('tr');
    const tdAct = document.createElement('td'); tdAct.className='activity'; tdAct.textContent = a;
    const tdPort = document.createElement('td'); tdPort.textContent = '-';
    const tdP1 = document.createElement('td'); tdP1.style.textAlign='center';
    const tdP3 = document.createElement('td'); tdP3.style.textAlign='center';
    const tdP4 = document.createElement('td'); tdP4.style.textAlign='center';
    const tdP5 = document.createElement('td'); tdP5.style.textAlign='center';
    tdP1.innerHTML = '<span class="tick" data-stage="P1"> </span>';
    tdP3.innerHTML = '<span class="tick" data-stage="P3"> </span>';
    tdP4.innerHTML = '<span class="tick" data-stage="P4"> </span>';
    tdP5.innerHTML = '<span class="tick" data-stage="P5"> </span>';
    tr.appendChild(tdAct);
    tr.appendChild(tdPort);
    tr.appendChild(tdP1);
    tr.appendChild(tdP3);
    tr.appendChild(tdP4);
    tr.appendChild(tdP5);
    tbody.appendChild(tr);
  }
}

/** Update UI with API response */
async function updateUI(data, matric){
  setApiStatus('ok');
  if(!data || data.status !== 'ok'){
    // not found
    document.getElementById('studentName').textContent = '—';
    document.getElementById('matricView').textContent = matric || '—';
    document.getElementById('lastUpdate').textContent = '-';
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('donutRing').style.background = 'conic-gradient(var(--purple) 0deg,#eee 0deg)';
    document.getElementById('pctText').textContent = '0%';
    return;
  }

  const m = data.milestones || {};
  document.getElementById('studentName').textContent = data.studentName || '—';
  document.getElementById('matricView').textContent = data.matric || '—';
  document.getElementById('lastUpdate').textContent = data.lastUpdate || '-';
  // show simple fields if exist
  if(data.studentName) document.getElementById('studentName').textContent = data.studentName;
  // calculate completed milestone count (we treat P1,P3,P4,P5 each as 1 milestone)
  const stages = ['P1','P3','P4','P5'];
  let completedStages = 0;
  for(const s of stages){
    if(m[s] && String(m[s]).trim() !== '') completedStages++;
  }
  const percent = Math.round((completedStages / stages.length) * 100);
  // donut update (conic-gradient)
  const deg = Math.max(0, Math.min(360, Math.round((percent/100) * 360)));
  document.getElementById('donutRing').style.background = `conic-gradient(var(--purple) ${deg}deg, #eee ${deg}deg)`;
  document.getElementById('pctText').textContent = `${percent}%`;
  // summary
  document.getElementById('summaryCompleted').textContent = `${completedStages} / ${stages.length}`;

  // timeline: for each row mark P1/P3/P4/P5 based on mapping
  const rows = document.querySelectorAll('#timelineBody tr');
  rows.forEach(tr=>{
    const activity = tr.querySelector('.activity').textContent;
    const stage = ACT_TO_COL[activity] || '';
    // find the tick element for that stage in this row
    const tick = tr.querySelector(`.tick[data-stage="${stage}"]`);
    if(tick){
      // if stage present in milestones -> mark as done
      if(m[stage] && String(m[stage]).trim()!==''){
        tick.classList.add('done');
        tick.textContent = '✓';
      } else {
        tick.classList.remove('done');
        tick.textContent = '';
      }
    }
  });

  // files: P5_DocUrl if exists
  const fileList = document.getElementById('fileList');
  fileList.innerHTML = '';
  // Some sheets store a P5_DocUrl column; we try to use m.P5_DocUrl or m.P5_Doc or similar
  const candidateUrls = [];
  if(m.P5_DocUrl) candidateUrls.push({name:'P5 report', url:m.P5_DocUrl});
  if(m.P5_Doc) candidateUrls.push({name:'P5 doc', url:m.P5_Doc});
  // also if the API returned saved files array (not default) include them
  if(data.files && Array.isArray(data.files)){
    data.files.forEach(f=>{
      if(f.url) candidateUrls.push({name:f.name||f.field||'file', url:f.url});
    });
  }
  if(candidateUrls.length===0){
    fileList.innerHTML = '<div style="color:var(--muted)">No uploaded files found.</div>';
  } else {
    candidateUrls.forEach(f=>{
      const el = document.createElement('div'); el.className='file';
      const a = document.createElement('a'); a.href = f.url; a.target='_blank'; a.textContent = f.name || f.url;
      el.appendChild(a); fileList.appendChild(el);
    });
  }
}

/** Fetch API /api/status */
async function check(){
  const mVal = document.getElementById('matric').value.trim();
  if(!mVal){ alert('Enter matric'); return; }
  setApiStatus('loading');
  try{
    const r = await fetch(`/api/status?matric=${encodeURIComponent(mVal)}`);
    const j = await r.json();
    updateUI(j, mVal);
  }catch(err){
    console.error(err); setApiStatus('error'); alert('API error: ' + err.message);
  }
}

/** Load dashboard data */
async function loadDashboard(){
  setApiStatus('loading');
  try{
    const r = await fetch('/api/dashboardData');
    const j = await r.json();
    document.getElementById('summaryTotal').textContent = 'Total students: ' + (j.totals? j.totals.total : 0);
    setApiStatus('ok');
  }catch(err){
    console.error(err); setApiStatus('error'); alert('API error: ' + err.message);
  }
}

/** Approve action for supervisor */
async function approve(){
  const matric = document.getElementById('_svmat').value.trim() || document.getElementById('matric').value.trim();
  const stage = document.getElementById('_svstage').value;
  const pass = document.getElementById('_svpass').value;
  if(!matric){ alert('Enter matric'); return; }
  setApiStatus('approving...');
  try{
    const body = { _svpass: pass, matric, stage };
    const r = await fetch('/api/approve', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const j = await r.json();
    document.getElementById('approveResult').textContent = JSON.stringify(j);
    // reload student
    await check();
  }catch(err){
    console.error(err);
    document.getElementById('approveResult').textContent = 'Error: ' + err.message;
  } finally { setApiStatus('ok'); }
}

/** Download approval log */
function downloadApprovalLog(){
  window.location.href = '/api/approval_log';
}

/* init */
buildTimeline();
setApiStatus('idle');

// if a matric is present in the query string, auto-check
(function(){
  const params = new URLSearchParams(location.search);
  const m = params.get('matric');
  if(m){
    document.getElementById('matric').value = m;
    check();
  }
})();
</script>
</body>
</html>
