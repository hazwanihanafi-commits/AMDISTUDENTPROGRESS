<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Printable - AMDI Student Progress</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/css/printable.css">
</head>
<body>
  <header class="print-header">
    <div class="brand">AMDI STUDENT PROGRESS</div>
  </header>

  <main class="print-wrap">
    <section class="left">
      <div class="student-meta">
        <div><strong>Name:</strong> <span id="name">—</span></div>
        <div><strong>Matric:</strong> <span id="matric">—</span></div>
        <div><strong>Start date:</strong> <span id="start">—</span></div>
      </div>

      <table class="timeline-table">
        <thead><tr><th>Activity</th><th>Expected</th><th>Timeline</th></tr></thead>
        <tbody id="activityRows"></tbody>
      </table>

      <div class="sign-block">
        <div>Supervisor signature: ______________________________</div>
        <div>Date: __________________</div>
      </div>
    </section>

    <aside class="right">
      <div class="progress-card">
        <h3>Progress</h3>
        <div id="ring" class="ring"></div>
        <div id="pct" class="pct">0%</div>
        <div style="margin-top:18px">
          <button id="doPrint">Print</button>
        </div>
      </div>
    </aside>
  </main>

<script>
async function fetchJson(url){ const r = await fetch(url); return await r.json(); }
function qs(name){ const u = new URL(location.href); return u.searchParams.get(name); }

function setRing(pct){
  const deg = Math.round((pct/100) * 360);
  document.getElementById('ring').style.background = `conic-gradient(#ffd600 ${deg}deg,#eee ${deg}deg)`;
  document.getElementById('pct').textContent = pct + '%';
}

async function loadPrintable(){
  const m = qs('matric');
  if(!m) { alert('missing matric'); return; }
  const j = await fetchJson('/api/timeline?matric=' + encodeURIComponent(m) + '&template=m');
  if(!j || j.status !== 'ok'){ alert('Student not found'); return; }
  document.getElementById('name').textContent = j.studentName || '—';
  document.getElementById('matric').textContent = j.matric || '—';
  document.getElementById('start').textContent = (new Date(j.startDate)).toLocaleDateString();

  // Build activity rows
  const tbody = document.getElementById('activityRows'); tbody.innerHTML = '';
  (j.activities || []).forEach(a => {
    const tr = document.createElement('tr');
    const timeline = Object.keys(a.quarterTicks || {}).filter(k => a.quarterTicks[k]).join(', ');
    tr.innerHTML = `<td>${a.activity}</td><td></td><td>${timeline}</td>`;
    tbody.appendChild(tr);
  });

  // progress from milestones
  const mks = j.milestones || {};
  let done = 0;
  ['P1','P3','P4','P5'].forEach(s => { if (mks[s] && String(mks[s]).trim()!=='') done++; });
  const pct = Math.round((done/4)*100);
  setRing(pct);
}

document.getElementById('doPrint')?.addEventListener('click', ()=> window.print());
window.addEventListener('DOMContentLoaded', loadPrintable);
</script>
</body>
</html>
