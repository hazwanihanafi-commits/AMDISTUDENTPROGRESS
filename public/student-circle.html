<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AMDI Student — Circle Progress</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{
      --purple:#5b2b7b;
      --muted:#666;
      --bg:#f9f9fb;
      --card:#ffffff;
      --accent:#efe6f6;
      --green:#9fd8a3;
    }
    body{font-family: "Segoe UI", Roboto, Arial; background:var(--bg); color:#222; margin:0; padding:18px;}
    .wrap{max-width:980px;margin:12px auto;display:flex;gap:20px;flex-wrap:wrap}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(20,20,40,0.05);flex:1;min-width:300px}
    header{background:var(--purple);color:#fff;padding:14px 18px;border-radius:10px;margin-bottom:14px}
    header h1{margin:0;font-size:18px;letter-spacing:1px}
    .controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    input[type="text"]{padding:10px;border-radius:8px;border:1px solid #ddd;font-size:16px;flex:1}
    button{padding:10px 14px;border-radius:8px;border:none;background:var(--purple);color:#fff;cursor:pointer}
    .layout{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap}
    .left{width:360px;min-width:260px}
    .right{flex:1;min-width:260px}
    /* thick ring */
    .ring-wrap{display:flex;align-items:center;justify-content:center;height:300px}
    .ring {
      width:220px;height:220px;border-radius:50%;
      display:grid;place-items:center;
      background: conic-gradient(var(--purple) 0deg, #eee 0deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
    }
    .ring .core{
      width:130px;height:130px;border-radius:50%;background:#fff;display:grid;place-items:center;text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }
    .ring .core .num{font-size:28px;font-weight:800;color:var(--purple)}
    .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .timeline{margin-top:10px;border-collapse:collapse;width:100%}
    .timeline th, .timeline td{padding:8px;border:1px solid #f0eef3;font-size:14px;text-align:left}
    .timeline th{background:#faf6fe;color:var(--purple)}
    .tick{display:inline-block;width:24px;height:24px;border-radius:6px;border:1px solid #ddd;line-height:24px;text-align:center}
    .tick.done{background:var(--green);border-color:transparent;color:#fff}
    .files{margin-top:12px}
    .file a{display:inline-block;margin-right:8px;padding:6px 10px;border-radius:8px;background:#fff;border:1px solid #eee;text-decoration:none;color:var(--purple)}
    .small{font-size:13px;color:var(--muted)}
    @media (max-width:880px){ .layout{flex-direction:column} .left{width:100%} }
  </style>
</head>
<body>
  <header><h1>AMDI Student Progress — Circle View</h1></header>

  <div class="card">
    <div class="controls">
      <input id="matric" placeholder="Enter matric (e.g. 23200051)" />
      <button onclick="check()">Check</button>
      <button onclick="loadDashboard()" style="background:#444;margin-left:6px">Load Stats</button>
      <div style="margin-left:auto" class="small" id="apiStatus">idle</div>
    </div>

    <div class="layout">
      <div class="left card" style="padding:12px">
        <div class="ring-wrap">
          <div id="ring" class="ring" aria-hidden="true">
            <div class="core">
              <div class="num" id="pct">0%</div>
              <div class="small">Progress</div>
            </div>
          </div>
        </div>

        <div style="text-align:center;margin-top:8px">
          <div id="studentName" style="font-weight:700;font-size:18px">—</div>
          <div id="matView" class="small">Matric: —</div>
          <div id="lastUpdate" class="small">Last update: —</div>
        </div>

        <div class="files" id="fileList"></div>
      </div>

      <div class="right card" style="padding:12px">
        <h3 style="margin-top:0">Timeline & Milestones</h3>
        <table class="timeline" id="tl">
          <thead>
            <tr><th style="width:56%">Activity</th><th style="width:12%;text-align:center">P1</th><th style="width:12%;text-align:center">P3</th><th style="width:12%;text-align:center">P4</th><th style="width:12%;text-align:center">P5</th></tr>
          </thead>
          <tbody id="timelineBody">
            <!-- populated by JS -->
          </tbody>
        </table>
        <div style="margin-top:12px" id="summary" class="small"></div>
      </div>
    </div>
  </div>

<script>
/* Student circle view (Option A: Thick solid ring) */
const ACTIVITIES = [
  "Registration & Orientation",
  "Literature Review & Proposal Preparation",
  "Proposal Defence",
  "Research Ethics Approval (JEPeM)",
  "Research Implementation I",
  "Mid-Candidature Review",
  "Research Communication I",
  "Research Implementation II",
  "Publication I",
  "Research Dissemination",
  "Thesis Preparation",
  "Pre-Submission Review (JPMPMP)",
  "Thesis Examination & Completion"
];
const ACT_TO_COL = {
  "Registration & Orientation":"P1",
  "Literature Review & Proposal Preparation":"P1",
  "Proposal Defence":"P1",
  "Research Ethics Approval (JEPeM)":"P1",
  "Research Implementation I":"P3",
  "Mid-Candidature Review":"P3",
  "Research Communication I":"P3",
  "Research Implementation II":"P4",
  "Publication I":"P4",
  "Research Dissemination":"P4",
  "Thesis Preparation":"P4",
  "Pre-Submission Review (JPMPMP)":"P5",
  "Thesis Examination & Completion":"P5"
};

const EXCEL_PATH = '/mnt/data/MasterTrackingProgress.xlsx'; // uploaded file path (for migration scripts)

function setApiStatus(s){ document.getElementById('apiStatus').textContent = s; }
function buildTimeline(){ const tbody=document.getElementById('timelineBody'); tbody.innerHTML=''; for(const a of ACTIVITIES){
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${a}</td>
    <td style="text-align:center"><span class="tick" data-stage="P1"></span></td>
    <td style="text-align:center"><span class="tick" data-stage="P3"></span></td>
    <td style="text-align:center"><span class="tick" data-stage="P4"></span></td>
    <td style="text-align:center"><span class="tick" data-stage="P5"></span></td>`;
  tbody.appendChild(tr);
}}
buildTimeline();

async function check(){
  const m = document.getElementById('matric').value.trim();
  if(!m){ alert('Enter matric'); return; }
  setApiStatus('loading');
  try{
    const r = await fetch('/api/status?matric=' + encodeURIComponent(m));
    const j = await r.json();
    renderStudent(j, m);
    setApiStatus('ok');
  }catch(err){
    console.error(err); setApiStatus('error'); alert('API error: ' + err.message);
  }
}

function markTicks(milestones){
  const rows = document.querySelectorAll('#timelineBody tr');
  rows.forEach(tr=>{
    const activity = tr.cells[0].textContent;
    const stage = ACT_TO_COL[activity];
    ['P1','P3','P4','P5'].forEach(s=>{
      const tick = tr.querySelector(`.tick[data-stage="${s}"]`);
      tick.classList.remove('done'); tick.textContent='';
    });
    if(stage && milestones[stage] && String(milestones[stage]).trim()!==''){
      // set done for that entire row's stage
      const tick = tr.querySelector(`.tick[data-stage="${stage}"]`);
      if(tick){ tick.classList.add('done'); tick.textContent='✓'; }
    }
  });
}

function renderStudent(data, matric){
  if(!data || data.status !== 'ok'){
    document.getElementById('studentName').textContent = 'Student not found';
    document.getElementById('matView').textContent = 'Matric: ' + (matric || '-');
    document.getElementById('lastUpdate').textContent = 'Last update: -';
    document.getElementById('pct').textContent = '0%';
    document.getElementById('ring').style.background = `conic-gradient(var(--purple) 0deg, #eee 0deg)`;
    document.getElementById('fileList').innerHTML = '';
    document.getElementById('summary').textContent = '';
    markTicks({});
    return;
  }

  const m = data.milestones || {};
  document.getElementById('studentName').textContent = data.studentName || '—';
  document.getElementById('matView').textContent = 'Matric: ' + (data.matric || '-');
  document.getElementById('lastUpdate').textContent = 'Last update: ' + (data.lastUpdate || '-');

  // compute progress: P1,P3,P4,P5 each 25%
  const stages = ['P1','P3','P4','P5'];
  let completed = 0;
  stages.forEach(s => { if(m[s] && String(m[s]).trim()!=='') completed++; });
  const percent = Math.round((completed / stages.length) * 100);
  document.getElementById('pct').textContent = percent + '%';
  const deg = Math.round((percent/100) * 360);
  document.getElementById('ring').style.background = `conic-gradient(var(--purple) ${deg}deg, #eee ${deg}deg)`;

  markTicks(m);
  document.getElementById('summary').textContent = `${completed} of ${stages.length} milestones completed`;

  // files
  const fileList = document.getElementById('fileList');
  fileList.innerHTML = '';
  const urls = [];
  if(m.P5_DocUrl) urls.push({name:'P5 report', url:m.P5_DocUrl});
  if(data.files && Array.isArray(data.files)) data.files.forEach(f=>{ if(f.url) urls.push({name:f.name||'file', url:f.url}); });
  if(urls.length===0) fileList.innerHTML = '<div class="small">No files uploaded</div>';
  else urls.forEach(f=>{
    const a = document.createElement('a'); a.href = f.url; a.target='_blank'; a.textContent = f.name; a.className='filelink';
    a.style.display='inline-block'; a.style.marginRight='8px'; a.style.padding='6px 10px'; a.style.border='1px solid #eee'; a.style.borderRadius='8px';
    fileList.appendChild(a);
  });
}

async function loadDashboard(){
  setApiStatus('loading');
  try{
    const r = await fetch('/api/dashboardData');
    const j = await r.json();
    const total = j.totals? j.totals.total : 0;
    alert('Total students: ' + total);
    setApiStatus('ok');
  }catch(e){ setApiStatus('error'); alert('dashboard error'); }
}

// auto-check matric from query string
(function(){
  const params = new URLSearchParams(location.search);
  const m = params.get('matric');
  if(m){ document.getElementById('matric').value = m; check(); }
})();
</script>
</body>
</html>
